# .clinerules – PSADT AI Agent backend (Flask + SQLite)

## 0 · Definition of Done
* Every push must pass GitHub Actions: **Ruff, Ruff-format, Mypy --strict, Pytest**. :contentReference[oaicite:0]{index=0}
* Alembic migrations must be autogenerated & applied with `alembic upgrade head`. :contentReference[oaicite:1]{index=1}
* OpenAPI docs must load at `/docs` (Flask-Pydantic). :contentReference[oaicite:2]{index=2}

## 1 · Folder Structure (hard rules)
| Path | Purpose |
|------|---------|
| `src/ai_psadt_agent/api/` | Flask Blueprints |
| `src/ai_psadt_agent/services/` | Stateless business & AI logic |
| `src/ai_psadt_agent/domain_models/` | SQLAlchemy & Pydantic models |
| `migrations/` | Alembic scripts (`render_as_batch=True` for SQLite) :contentReference[oaicite:3]{index=3} |
| `tests/` | Pytest suites; use fixtures only |

## 2 · Commit Conventions
* Follow **Conventional Commits** (`feat:`, `fix:`, `chore:`, `refactor:`, `docs:`). :contentReference[oaicite:4]{index=4}
* Limit subject to 72 chars; body wrapped at 100.
* Auto-generated Ruff fixes get `style:` prefix. :contentReference[oaicite:5]{index=5}

## 3 · Code-Quality Gates
* Ruff lints & formats (`ruff check .` / `ruff format .`). :contentReference[oaicite:6]{index=6}
* Mypy runs in **strict** mode; no `Any` except vendored stubs.
* Pre-commit hooks must run locally before push. :contentReference[oaicite:7]{index=7}

## 4 · Database & Migrations
* Primary URL: `sqlite:///aipackager.db`.
* `Base` lives in `domain_models/base.py`; import in Alembic `env.py`.
* Every model change ⇒ `alembic revision --autogenerate` (+ batch mode). :contentReference[oaicite:8]{index=8}

## 5 · AI Generation Rules
* Always call `services/llm_client.generate()`—never raw API keys in code.
* Ground every prompt with top-k (8) Chroma chunks from PSADT docs. :contentReference[oaicite:9]{index=9}
* Validate output with compliance linter; reject hallucinations.

## 6 · Security & Secrets
* No secret strings checked into git—use `.env` + GitHub Secrets.
* Rate-limit AI endpoints via Flask-Limiter (100 req / 10 min IP).

## 7 · Plan/Act Loop Guidance (for Cline)
1. **Plan**: list tasks, reference ticket IDs.
2. **Act**: edit files, run tests, commit & `git push`.
3. If pre-commit hooks modify files, stage them and re-commit. :contentReference[oaicite:10]{index=10}
4. Stop the sprint when the Definition of Done for that sprint passes; ask for human review if failing tests persist after 3 auto-fix attempts. :contentReference[oaicite:11]{index=11}

## 8 · Stopping Conditions (per Sprint)
* **Sprint 1**: CRUD endpoints + docs green.
* **Sprint 2**: `/v1/generate` produces compliant script for 3 fixtures.
* **Sprint 3**: Binary built with Shiv; CI green; release tagged v1.0.0.

---


The most important Rule is the KISS Rule!! Keep it simple stupid!!
